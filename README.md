# Hackathon. Постановка задачи
## Задача
Создание прогнозной модели для детектирования угла
расхождения строп при погрузочных работах.

## Желаемый результат
MVP с функционалом:
- Принимает изображение (фото погрузки)
- Оценивает угол между строп
- Выдает результат измерения

## Критерии оценки решения
1. Понимание проблематики: Заказчика и Исполнителя (проблема бизнеса
и проблема тех. реализации)
2. Техническое решение: качество, глубина проработки и пр.
3. Креатив и инновационность
4. Качество и полнота презентации решения
5. Ответы на доп. вопросы

# Hackathon. Проект
## Структура проекта
Для решения поставленной задачи было принято решение о разбиении проекта на несколько основных структурных блоков, в рамках каждого из которых будут выделены подзадачи для программной и аналитической реализации.
### 1. Подготовка данных
Основой любого проекта, связанного с данными, является их подготовка. При решении комплексной задачи машинного обучения данные необходимо отобрать, разметить и разделить, что и легло в основу ключевых подзадач.
#### 1.1. Отбор кадров
На этом этапе в исходном видео-материале обнаруживаются фрагменты, содержащие целевые объекты. После чего видео материал разбивается на отдельные кадры, которые отправляются на дальнейшую обработку.
#### 1.2. Разметка данных
Отобранные данные размечаются для обработки нейронной сетью и переводятся в удобный формат. 
![](images/detection_1.jpg?size=50)

![](images/detection_2.jpg?size=50)

В качестве целевых объектов выделяются отдельные стропы, а также контур контейнера.
#### 1.3. Увеличение кадровой выборки
Ограниченное количество кадров в выборке для повышения эффективности дальнейшего обучения модели увеличивается методами вариации контраста, яркости и размытия. Разметка сохраняется путем применения к ней геометрических преобразований, аналогичных преобразованиям изображений.
#### 1.4. Подготовка наборов
Отобранные данные разбиваются на наборы для обучения, тестирования и валидации.
### 2. Выделение целевых объектов
В данном модуле проекта отобранные сырые данные обретают математические очертания.
#### 2.2. Нейро-модуль
![](images/model.png?size=50)

В основе проекта лежит нейросетевой модуль, подобный Fast RCCN. Модель будет обучаться на обучающей выборке, а затем применяться к тестовым данным для поиска целевых объектов – строп, на которых подвешен контейнер. Выделенные прямоугольные сегменты со стропами должны поступать на вход следующему блоку.
#### 2.3. CV-модуль
![](images/lines.png?size=50)

Модуль компьютерного зрения на основе пакетов open-cv применяется для поиска на выделенных участках изображения со тропой точной линии, по которой проходит стропа. Методы компьютерного зрения, в частности пространственная фильтрация, способны справиться с этой задачей достаточно эффективно и быстро, сохранив при этом вычислительные ресурсы.
### 3. Расчетный блок
Заключительный алгебраическо-геометрический блок по определенным линиям находит точки пересечения и углы между стропами. В итоге, именно этот блок выносит вердикт по проделанной работе.
## Результат
### Общие задачи
 - Произведен обзор методов
 - Отобраны наиболее релевантные методы
 - Осуществлена аналитическая работа и оценка
 - Организована API между сегментами проекта
 - Организована визуализация результата
### Подготовка данных
 - Реализован отбор кадров для обработки из тестового фильма
 - Отобрана выборка из подходящих для представления модели
 - Осуществлена разметка

![](images/img1.png?size=50)
![](images/img2.png?size=50)
![](images/img3.png?size=50)
![](images/img4.png?size=50)
 - Осуществлено расширение выборки методом варьирования контраста и яркости
 - Сет разбит на Train, Test и Validation
### Выделение целевых объектов
 - Первая модель сети создана и первично обучена, сделаны выводы о необходимости усовершенствования обучающей выборки
 - Обучена более совершенная модель, модификации исходной выборки учтены

![](images/plot_1.jpg?size=50)

![](images/plot_2.jpg?size=50)

 - Создана грубая модель CV блока
 - Подобран подходящий CV блок, работающий достаточно эффективно
### Расчетный блок
 - Создан прототип вычислителя и определителя углов
 - Создан расчетный блок высокого качества

## Итоговая модель

![](images/hackathon_scheme_1.png?size=50)

Итоговая модель выполняет поставленную задачу с достаточно высокой эффективностью.
Она имеет сложную структуру и пространство для дальнейшего совершенствования.

### 1. Входные данные
Входное видео разбито на отдельные изображения и поступает на вход модели в виде отдельных кадров.
### 2. Нейромодуль
Обученная на отобранных, размеченных, размноженных, разделенных и усовершенствованных ранее данных
нейронная сеть Fast RCNN эффективно выполняет свою работу в данном сегменте.
Она находит отдельные контейнеры и стропы, передавая информацию о квадратных регионах с этими объектами
в CV-модуль.
### 3. CV-модуль
По определенным координатам фрагментов изображения вырезает эти сегменты из изображения,
а затем находит линии строп, передавая координаты 2-х точек каждой линии в вычислительный модуль.
Для реализации работы модуля были задействованы методы Билатеральной фильтрации (Bilateral filtering)
и детектора границ Канни (Canny edge detection).

### 4. Геометрический модуль
Полученные наборы точек позволяют геометрическому модулю расчитать уравнения прямых - строп,
вычислить углы между стропами, а затем вынести вердикт о допустимости угла.
### 5. Выходные данные
На выход программа выдает кадр с размеченными стропами и контейнером, снизу
изображена таблица углов, под которыми пересекаются стропы. Некорректные углы подсвечены красным (графически отображены).
После выполнения полной операции для одного кадра происходит повторение цикла для следующего кадра.
![](images/detected.jpg?size=50)

## Пространство для дальнейшей доработки
 - Допустим поиск более совершенной нейронной модели
 - Допустимо внедрение второй нейронной сети вместо CV блока для поиска строп в обрезанном по границам контейнера кадре
 - Допустимо обучение начальной модели не на боксах со стропами, а на прямых, которым стропы принадлежат
 - Внедрение в вычислительный модуль матричного преобразования в 3D с учетом глубины кадра
 - Внедрение переключения между CV на участках разного типа фона
 - Включение обратной связи учета предыдущего положения строп (положения на прошлом кадре) для улучшения детекции
 - Улучшение визуализации
